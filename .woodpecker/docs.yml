variables:
  - &golang_image 'golang:1.18.7'
  - &node_image 'node:18-alpine'
  - &when_path
    - "docs/**"
    - ".woodpecker/docs.yml"
    # since we generate docs for cli tool we have to watch this too
    - "cli/**"
    - "cmd/cli/**"

pipeline:
  build-cli:
    image: *golang_image
    commands:
      - make docs
    when:
      path: *when_path

  build:
    image: *node_image
    directory: docs/
    commands:
      - corepack enable
      - pnpm install --frozen-lockfile
      - pnpm build
    when:
      path: *when_path

  securitycheck:
    image: aquasec/trivy:latest
    commands:
      - trivy fs --exit-code 0 --skip-dirs node_modules/ --skip-dirs plugins/woodpecker-plugins/node_modules --severity UNKNOWN,LOW docs/
      # TODO currently it is not fixable so just do not block currently
      - trivy fs --exit-code 0 --skip-dirs node_modules/ --skip-dirs plugins/woodpecker-plugins/node_modules --severity MEDIUM,HIGH,CRITICAL docs/
    when:
      path: *when_path

  deploy-preview:
    image: woodpeckerci/plugin-surge-preview:next
    settings:
      path: "docs/build/"
      surge_token:
        from_secret: SURGE_TOKEN
      forge_type: github
      forge_url: "https://github.com"
      forge_repo_token:
        from_secret: GITHUB_TOKEN_SURGE
    when:
      event: pull_request
      path: *when_path

  # TODO: add step to remove preview again after PR is closed (waiting for #286)

  deploy-prepare:
    image: alpine
    commands:
      - apk add --no-cache git rsync
      # copy all docs files and delete all old ones, but leave CNAME and index.yaml untouched
      - git clone -b ${CI_REPO_DEFAULT_BRANCH} --single-branch https://github.com/woodpecker-ci/woodpecker-ci.github.io pages_repo
    when:
      event: push
      branch: ${CI_REPO_DEFAULT_BRANCH}
      path: *when_path

  deploy:
    image: appleboy/drone-git-push
    secrets:
      - BOT_PRIVATE_KEY
    settings:
      branch: ${CI_REPO_DEFAULT_BRANCH}
      ssh_key:
        from_secret: BOT_PRIVATE_KEY
      remote: git@github.com:woodpecker-ci/woodpecker-ci.github.io.git
      author_name: woodpecker-bot
      author_email: woodpecker-bot@obermui.de
      commit_message: Deploy website - based on ${CI_COMMIT_SHA}
      path: pages_repo
    when:
      event: push
      branch: ${CI_REPO_DEFAULT_BRANCH}
      path: *when_path
